#! /bin/sh

now=$(date --utc +%s)
today=$(expr "$now" / 86400 '*' 86400)

name="knockside-$now"
out="$name.jpg"

# Capture an image:
#
# - Sync the clock first so that the EXIF timestamp is accurate.
# - Make sure the camera is in record mode (necessary if the camera has just
#   powered on).
# - Capture the image.
# - Lock auto-focus so that the camera doesn't constantly refocus while left in
#   record mode.
#
# We intentionally leave the camera in record mode so that the lens doesn't
# retract inbetween shots (causing pointless wear and tear to the mechanism).
chdkptp \
    -c \
    -e"clock -sync" \
    -e"rec" \
    -e"remoteshoot $name -jpg -sd=inf -sdmode=MF" \
    -e"lua set_aflock(1)"

if ! [ -r "$out" ]
then
    echo "$0: capture $out does not exist!" 2>&1
    exit 1
fi

aws s3 cp "$out" "s3://knockside.scot/webcam/masters/$today/$out"
rm "$out"
